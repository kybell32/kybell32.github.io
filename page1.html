<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>소셜 미디어 연구_p1</title>
<style>
  body{margin:0;height:100vh;display:flex;align-items:center;justify-content:center;background:#f6f7f9;font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Arial,sans-serif;color:#111827}
  .popup{background:#fff;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,.1);padding:24px;max-width:320px;width:100%;text-align:center}
  h1{font-size:18px;margin:0 0 12px}
  .row{display:flex;gap:8px;justify-content:center}
  input[type="text"]{flex:1;padding:10px;font-size:18px;text-align:center;border:1px solid #ccc;border-radius:8px;letter-spacing:4px}
  button{border:none;background:#2563eb;color:#fff;padding:10px 16px;border-radius:8px;cursor:pointer;font-weight:600}
  button:disabled{opacity:.5;cursor:not-allowed}
  .hint{font-size:12px;color:#6b7280;margin-top:8px}
</style>
</head>
<body>
<div class="popup">
  <h1>전화 번호 뒷자리 4개를 입력해 주세요.</h1>
  <div class="row">
    <input id="idtail" type="text" inputmode="numeric" pattern="\\d{4}" maxlength="4" placeholder="4자리" />
    <button id="submitBtn" disabled>입력</button>
  </div>
  <div class="hint">숫자 4자리만 입력</div>
</div>

<script>
/***** ▼ 설정 ▼ *****/
const API = "https://script.google.com/macros/s/AKfycbxhI7GJJI2jebIWhxr_3nkvvYStEtzNjFZpUuIezsnNKd7G1Mf8emvyrW_AJUsZNg2U/exec";
const PAGE = 1;
const NEXT_PAGE_URL = "page2.html";
/***** ▲ 설정 끝 ▲*/

(function(){
  const qs = new URLSearchParams(location.search);
  const pid = qs.get('pid') || localStorage.getItem('exp_pid') || '';

  const idInput = document.getElementById('idtail');
  const submitBtn = document.getElementById('submitBtn');

  const isValid = v => /^\d{4}$/.test(v);

  function syncButton(){
    submitBtn.disabled = !isValid(idInput.value.trim());
  }

  idInput.addEventListener('input', ()=>{
    idInput.value = idInput.value.replace(/\D/g,'').slice(0,4);
    syncButton();
  });
  syncButton();

  async function upsertSession(idTail){
    const payload = {
      type: 'SESSION_UPSERT',
      pid,
      page: PAGE,
      answers: [
        { key: 'P1_IDTAIL', value: idTail }
      ]
    };
    const res = await fetch(API, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify(payload)
    });
    if (!res.ok) console.warn('SESSION_UPSERT failed (HTTP):', res.status);
  }

  async function submitAndNext(){
    const idTail = idInput.value.trim();
    if (!isValid(idTail)) return;

    try { await upsertSession(idTail); } catch(e){ console.warn(e); }

    const next = `${NEXT_PAGE_URL}?pid=${encodeURIComponent(pid)}`;
    location.href = next;
  }

  submitBtn.addEventListener('click', submitAndNext);

  // 페이지 닫기/새로고침 대비 sendBeacon 백업
  window.addEventListener('beforeunload', () => {
    try {
      const payload = JSON.stringify({ type:'SESSION_UPSERT', pid, page: PAGE, answers: [] });
      navigator.sendBeacon(API, new Blob([payload], { type:'text/plain' }));
    } catch(e){}
  });
})();
</script>
</body>
</html>
