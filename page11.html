<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>소셜 미디어 연구_p11</title>
<style>
  :root{--pri:#2563eb;--line:#e5e7eb;--muted:#6b7280}
  body{
    margin:0;height:100vh;display:flex;align-items:center;justify-content:center;
    background:#ffffff;font-family:system-ui,-apple-system,Segoe UI,Roboto,
    Apple SD Gothic Neo,Noto Sans KR,Arial,sans-serif;color:#111827
  }
  .card{
    max-width:640px;width:100%;margin:0 16px;background:#fff;
    border:1px solid var(--line);border-radius:16px;
    box-shadow:0 6px 24px rgba(0,0,0,.06);
    padding:28px;text-align:center
  }
  h1{margin:0 0 12px;font-size:22px}
  p{margin:8px 0;line-height:1.7}
  .muted{color:var(--muted);font-size:13px;margin-top:14px;display:flex;align-items:center;justify-content:center;gap:6px}
  .spinner{
    width:14px;height:14px;border:2px solid #ccc;
    border-top-color:var(--pri);border-radius:50%;
    animation:spin 0.8s linear infinite;
  }
  @keyframes spin{from{transform:rotate(0deg);}to{transform:rotate(360deg);}}
</style>
</head>
<body>
  <main class="card" aria-labelledby="ttl">
    <h1 id="ttl">연구 종료</h1>
    <p>모든 절차가 완료되었습니다. 참여해 주셔서 대단히 감사합니다.</p>
    <p>연락처로 디브리핑 및 보상 안내를 드리겠습니다.</p>
    <p>평안한 하루 보내세요 :)</p>
    <p class="muted" id="saveStatus">
      <span class="spinner"></span> 저장 중...
    </p>
  </main>

<script>
/***** ▼ 설정 ▼ *****/
const API = "https://script.google.com/macros/s/AKfycbxhI7GJJI2jebIWhxr_3nkvvYStEtzNjFZpUuIezsnNKd7G1Mf8emvyrW_AJUsZNg2U/exec";
const PAGE = 11;
/***** ▲ 설정 끝 ▲*/

(function(){
  const qs = new URLSearchParams(location.search);
  const pid = qs.get('pid') || localStorage.getItem('exp_pid') || '';
  const saveStatus = document.getElementById('saveStatus');

  async function sessionUpsert(answers){
    const payload = { type:'SESSION_UPSERT', pid, page: PAGE, answers };
    try{
      saveStatus.innerHTML = `<span class="spinner"></span> 저장 중...`;
      const res = await fetch(API, {
        method:'POST',
        headers:{'Content-Type':'text/plain'},
        body: JSON.stringify(payload),
        keepalive:true
      });
      if(!res.ok) throw new Error("HTTP "+res.status);
      await res.json().catch(()=>({}));
      saveStatus.innerHTML = `<span style="color:#16a34a;">✅ 저장 완료</span>`;
      return true;
    }catch(e){
      console.warn(e);
      saveStatus.innerHTML = `<span style="color:#dc2626;">⚠ 저장 실패 (네트워크 확인)</span>`;
      return false;
    }
  }

  async function finalize(){
    const ok = await sessionUpsert([
      { key:'P10_COMPLETE', value:'1' },
      { key:'P10_MESSAGE', value:'연구 종료 안내 표시' },
      { key:'STUDY_STATUS', value:'complete' }
    ]);

    // 저장 성공 시 localStorage 초기화 등 후처리도 가능
    if(ok){
      localStorage.removeItem('exp_pid');
      localStorage.removeItem('stimulus_variant');
    }
  }

  finalize();

  // 페이지 닫기 대비 sendBeacon (백업)
  window.addEventListener('beforeunload', ()=>{
    try{
      const payload = JSON.stringify({
        type:'SESSION_UPSERT',
        pid,
        page: PAGE,
        answers:[
          { key:'P10_COMPLETE', value:'1' },
          { key:'P10_MESSAGE', value:'연구 종료 안내 표시' },
          { key:'STUDY_STATUS', value:'complete' }
        ]
      });
      navigator.sendBeacon(API, new Blob([payload], {type:'text/plain'}));
    }catch(e){}
  });
})();
</script>
</body>
</html>
