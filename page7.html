<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>소셜 미디어 연구_p7b</title>
<style>
  /* 위와 동일한 스타일 복사 */
</style>
</head>
<body>
<header>설문 (2/2)</header>
<main>
  <h1>아래 문항에 응답해 주세요.</h1>

  <!-- sec3 -->
  <section class="section">
    <div class="card">
      <p class="title"><b>정신질환자들</b>이 아래에 제시되는 문장 속의 내용과 얼마나 일치하는지에 대해 동의하는 정도를 선택해 주십시오.</p>
      <p class="help">1(전혀 그렇지 않다) ~ 7(매우 그렇다)</p>
      <div id="sec3"></div>
    </div>
  </section>

  <div class="btn-area">
    <button id="nextBtn" class="btn" disabled>다음</button>
  </div>
</main>

<script>
const API = "https://script.google.com/macros/s/AKfycbxhI7GJJI2jebIWhxr_3nkvvYStEtzNjFZpUuIezsnNKd7G1Mf8emvyrW_AJUsZNg2U/exec";
const PAGE = "7b";
const NEXT_PAGE_URL = "page8.html";
const SEC3 = [...]; // 원래 코드의 SEC3 복사

/* 이하 스크립트는 위와 거의 동일, renderSection('sec3', SEC3) 만 호출 */
(function(){
  const qs = new URLSearchParams(location.search);
  const pid = qs.get('pid') || localStorage.getItem('exp_pid') || '';
  const nextBtn = document.getElementById('nextBtn');
  let sending = false;

  function renderSection(containerId, items){
    const wrap = document.getElementById(containerId);
    items.forEach(([text, name, qkey, scale])=>{
      const q=document.createElement('div');
      q.className='q';
      q.innerHTML=`<div class="qname">${text}</div><div class="scale" data-name="${name}" data-qkey="${qkey}" data-scale="${scale}"></div>`;
      wrap.appendChild(q);
    });
  }
  renderSection('sec3', SEC3);

  document.querySelectorAll('.scale').forEach(scale=>{
    const name=scale.dataset.name;const max=parseInt(scale.dataset.scale,10)||5;
    for(let v=1;v<=max;v++){
      const lab=document.createElement('label');
      lab.className='chip';
      lab.innerHTML=`<input type="radio" name="${name}" value="${v}"><strong>${v}</strong>`;
      scale.appendChild(lab);
    }
  });

  function refreshGroup(name){
    document.querySelectorAll(`label.chip input[name="${name}"]`).forEach(r=>{
      r.closest('label.chip').classList.toggle('selected',r.checked);
    });
  }
  document.querySelectorAll('label.chip>input').forEach(r=>{
    r.addEventListener('change',()=>refreshGroup(r.name));
  });

  const REQUIRED=[...document.querySelectorAll('.scale')].map(el=>el.dataset.name);
  function answeredAll(){return REQUIRED.every(n=>document.querySelector(`input[name="${n}"]:checked`));}
  function refreshBtn(){nextBtn.disabled=!answeredAll()||sending;}
  document.addEventListener('change',refreshBtn);

  async function sessionUpsert(answers){
    const payload={type:'SESSION_UPSERT',pid,page:PAGE,answers};
    await fetch(API,{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify(payload)});
  }

  function collectAnswers(){
    const out=[];
    document.querySelectorAll('.scale').forEach(scale=>{
      const name=scale.dataset.name, key=scale.dataset.qkey;
      const el=document.querySelector(`input[name="${name}"]:checked`);
      if(el) out.push({key,value:el.value});
    });
    return out;
  }

  nextBtn.addEventListener('click',async()=>{
    if(!answeredAll()||sending)return;
    sending=true;refreshBtn();
    try{await sessionUpsert(collectAnswers());}catch(e){console.warn(e);}
    location.href=`${NEXT_PAGE_URL}?pid=${encodeURIComponent(pid)}`;
  });
})();
</script>
</body>
</html>
