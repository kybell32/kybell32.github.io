<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>소셜 미디어 연구_p6</title>
<style>
  :root{--line:#e5e7eb;--pri:#2563eb;--muted:#6b7280;--bg:#f6f7f9}
  *{box-sizing:border-box}
  body{margin:0;background:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Arial,sans-serif;color:#111827;line-height:1.6}
  header{
    position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);
    padding:12px 16px;display:flex;justify-content:space-between;align-items:center;
    font-weight:700;
  }
  .status{font-size:14px;color:var(--muted);display:flex;align-items:center;gap:4px;}
  .spinner{
    width:14px;height:14px;border:2px solid #ccc;border-top-color:var(--pri);
    border-radius:50%;animation:spin 0.8s linear infinite;
  }
  @keyframes spin{from{transform:rotate(0deg);}to{transform:rotate(360deg);}}
  main{max-width:880px;margin:0 auto;padding:16px}
  h1{font-size:20px;margin:6px 0 16px}
  .card{background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.04);padding:14px}
  .q{border:1px solid var(--line);border-radius:12px;padding:12px;margin-top:12px}
  .qname{font-weight:700;margin-bottom:8px}
  .scale{display:flex;flex-wrap:nowrap;gap:8px;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none}
  .scale::-webkit-scrollbar{display:none}
  label.chip{position:relative;display:inline-flex;align-items:center;border:1px solid var(--line);border-radius:999px;padding:8px 10px;background:#fff;cursor:pointer;user-select:none;white-space:nowrap;line-height:1;transition:background .15s,border-color .15s,box-shadow .15s;font-size:14px}
  label.chip>input{position:absolute;inset:0;opacity:0;width:100%;height:100%;margin:0;cursor:pointer}
  label.chip strong{font-variant-numeric:tabular-nums;font-weight:700}
  label.chip:hover{background:#f9fafb}
  label.chip:focus-within{box-shadow:0 0 0 3px rgba(37,99,235,.2)}
  label.chip.selected{background:#eef2ff;border-color:#93c5fd;box-shadow:inset 0 0 0 2px #2563eb}
  label.chip.selected strong{color:#1d4ed8}
  .btn-area{text-align:center;margin-top:20px}
  .btn{border:none;border-radius:10px;padding:12px 18px;font-size:16px;background:var(--pri);color:#fff;font-weight:600;cursor:pointer}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  @media(max-width:480px){
    main{padding:12px}
    .card{padding:12px}
    .q{padding:10px}
    .scale{gap:6px}
    label.chip{padding:8px 9px;font-size:13.5px}
  }
</style>
</head>
<body>
<header>
  <div>문답</div>
  <div id="statusArea" class="status">
    <div class="spinner"></div>
    <span>저장 중...</span>
  </div>
</header>

<main>
  <h1>앞서 본 온라인 게시물의 어조에 대해 어느 정도 동의하는지 선택해 주세요.</h1>

  <section class="card">
    <div class="q">
      <div class="qname">1) 웃기다.</div>
      <div class="scale" data-name="q1" data-qkey="P6_Q1"></div>
    </div>
    <div class="q">
      <div class="qname">2) 재미있다.</div>
      <div class="scale" data-name="q2" data-qkey="P6_Q2"></div>
    </div>
    <div class="q">
      <div class="qname">3) 농담조가 강하다.</div>
      <div class="scale" data-name="q3" data-qkey="P6_Q3"></div>
    </div>
  </section>

  <div class="btn-area">
    <button id="nextBtn" type="button" class="btn" disabled>다음</button>
  </div>
</main>

<script>
/***** ▼ 설정 ▼ *****/
const API = "https://script.google.com/macros/s/AKfycbxhI7GJJI2jebIWhxr_3nkvvYStEtzNjFZpUuIezsnNKd7G1Mf8emvyrW_AJUsZNg2U/exec";
const PAGE = 7;
const NEXT_PAGE_URL = "page8.html";
/***** ▲ 설정 끝 ▲ *****/

(function(){
  const qs = new URLSearchParams(location.search);
  const pid = qs.get('pid') || localStorage.getItem('exp_pid') || '';
  const nextBtn = document.getElementById('nextBtn');
  const statusArea = document.getElementById('statusArea');
  let sending = false;

  // 칩 생성
  document.querySelectorAll('.scale').forEach(scale=>{
    const name = scale.dataset.name;
    for(let v=1; v<=5; v++){
      const lab=document.createElement('label');
      lab.className='chip';
      lab.innerHTML=`<input type="radio" name="${name}" value="${v}"><strong>${v}</strong>`;
      scale.appendChild(lab);
    }
  });

  function refreshGroup(name){
    document.querySelectorAll(`label.chip input[name="${name}"]`).forEach(r=>{
      const lab=r.closest('label.chip');
      lab.classList.toggle('selected',r.checked);
    });
  }
  document.addEventListener('change',e=>{
    if(e.target.matches('input[type="radio"]')){
      refreshGroup(e.target.name);
      refreshBtn();
    }
  });

  const REQUIRED=['q1','q2','q3'];
  function allAnswered(){return REQUIRED.every(n=>document.querySelector(`input[name="${n}"]:checked`));}
  function refreshBtn(){nextBtn.disabled=!allAnswered()||sending;}
  refreshBtn();

  // 데이터 저장 함수
  async function sessionUpsert(answers){
    const payload={type:'SESSION_UPSERT',pid,page:PAGE,answers};
    try{
      statusArea.innerHTML = `
        <div class="spinner"></div>
        <span>저장 중...</span>
      `;
      sending = true;
      refreshBtn();

      const res = await fetch(API,{
        method:'POST',
        headers:{'Content-Type':'text/plain'},
        body:JSON.stringify(payload),
        keepalive:true
      });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      await res.json().catch(()=>({}));

      statusArea.innerHTML = `<span style="color:#16a34a;">✅ 완료</span>`;
      sending = false;
      refreshBtn();
      return true;
    }catch(e){
      console.warn('저장 실패:',e);
      statusArea.innerHTML = `<span style="color:#dc2626;">⚠ 저장 실패</span>`;
      sending = false;
      refreshBtn();
      return false;
    }
  }

  nextBtn.addEventListener('click',async()=>{
    if(!allAnswered()||sending) return;
    sending=true; refreshBtn();

    function valOf(name){return document.querySelector(`input[name="${name}"]:checked`).value;}
    const answers=[
      {key:'P6_Q1',value:valOf('q1')},
      {key:'P6_Q2',value:valOf('q2')},
      {key:'P6_Q3',value:valOf('q3')}
    ];

    const ok = await sessionUpsert(answers);
    if(ok){
      // 약간의 지연으로 네트워크 안정 확보
      await new Promise(r=>setTimeout(r,300));
      location.href=`${NEXT_PAGE_URL}?pid=${encodeURIComponent(pid)}`;
    }
  });
})();
</script>
</body>
</html>
