<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>실험 v2 · Page 7 (설문 단계)</title>
<style>
  :root{--line:#e5e7eb;--pri:#2563eb;--bg:#f6f7f9;--muted:#6b7280}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Arial,sans-serif;color:#111827;line-height:1.6}
  header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);padding:12px;text-align:center;font-weight:700}
  main{max-width:980px;margin:0 auto;padding:18px}
  h1{font-size:20px;margin:6px 0 12px}
  .section{margin:14px 0 28px}
  .card{background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.04);padding:16px}
  .title{font-weight:700;margin:0 0 6px}
  .help{font-size:12px;color:var(--muted);margin:0 0 10px}
  .q{border:1px solid var(--line);border-radius:12px;padding:14px;margin-top:12px}
  .qname{font-weight:700;margin-bottom:8px}

  /* 칩 스케일: 한 줄 유지 + 필요 시 가로 스크롤 */
  .scale{
    display:flex; flex-wrap:nowrap; gap:8px;
    overflow-x:auto; -webkit-overflow-scrolling:touch; scrollbar-width:none;
  }
  .scale::-webkit-scrollbar{ display:none; }

  /* 칩(블럭) */
  label.chip{
    position:relative; display:inline-flex; align-items:center;
    border:1px solid var(--line); border-radius:999px;
    padding:8px 10px; background:#fff; cursor:pointer; user-select:none;
    white-space:nowrap; line-height:1; transition:background .15s, border-color .15s, box-shadow .15s;
    font-size:14px;
  }
  /* 라디오 자체는 보이지 않게(접근성 유지 위해 칩 전체 클릭 가능) */
  label.chip > input{
    position:absolute; inset:0; opacity:0; width:100%; height:100%; margin:0; cursor:pointer;
  }
  label.chip strong{ font-variant-numeric:tabular-nums; font-weight:700 }
  label.chip:hover{ background:#f9fafb }
  label.chip:focus-within{ box-shadow:0 0 0 3px rgba(37,99,235,.2) }

  /* 선택 상태 */
  label.chip.selected{
    background:#eef2ff;
    border-color:#93c5fd;
    box-shadow:inset 0 0 0 2px #2563eb;
  }
  label.chip.selected strong{ color:#1d4ed8 }

  .btn-area{text-align:center;margin-top:24px}
  .btn{border:none;border-radius:10px;padding:12px 20px;font-size:16px;background:#2563eb;color:#fff;font-weight:600;cursor:pointer}
  .btn:disabled{opacity:.5;cursor:not-allowed}

  /* 모바일(아주 좁은 화면)에서 패딩/간격 살짝 축소 */
  @media (max-width:480px){
    main{padding:12px}
    .card{padding:12px}
    .q{padding:12px}
    .scale{gap:6px}
    label.chip{padding:8px 9px;font-size:13.5px}
  }
</style>
</head>
<body>
<header>설문 단계</header>
<main>
  <h1>아래 문항에 응답해 주세요. 모든 문항에 응답해야 다음으로 이동할 수 있습니다.</h1>

  <!-- 섹션 1: 5점 척도 -->
  <section class="section">
    <div class="card">
      <p class="title">지난 2주 동안 소셜 미디어 사용에 대해 자신과 일치하는 정도</p>
      <p class="help">각 문항에 대해 1(매우 아니다) ~ 5(매우 그렇다)에서 하나 선택</p>
      <div id="sec1"></div>
    </div>
  </section>

  <!-- 섹션 2: 5점 척도 -->
  <section class="section">
    <div class="card">
      <p class="title">제시된 문항에 대한 동의 정도</p>
      <p class="help">1(매우 아니다) ~ 5(매우 그렇다)</p>
      <div id="sec2"></div>
    </div>
  </section>

  <!-- 섹션 3: 7점 척도 -->
  <section class="section">
    <div class="card">
      <p class="title">아래 문장 내용과의 일치 정도</p>
      <p class="help">1(전혀 그렇지 않다) ~ 7(매우 그렇다)</p>
      <div id="sec3"></div>
    </div>
  </section>

  <div class="btn-area">
    <button id="nextBtn" class="btn" disabled>다음</button>
  </div>
</main>

<script>
/***** ▼ 설정 ▼ *****/
const API = "https://script.google.com/macros/s/AKfycbxhI7GJJI2jebIWhxr_3nkvvYStEtzNjFZpUuIezsnNKd7G1Mf8emvyrW_AJUsZNg2U/exec";
const PAGE = 7;
const NEXT_PAGE_URL = "page8.html";
/***** ▲ 설정 끝 ▲ *****/

/* 문항 정의(텍스트, name, 저장키, 척도) */
const SEC1 = [
  ["소셜 미디어에 대해 생각하거나 사용계획을 세우는 데 많은 시간을 보냈습니까?", "s1_q1", "P7_S1_Q1", 5],
  ["소셜 미디어를 점점 더 많이 하고 싶다는 충동을 느꼈습니까?",           "s1_q2", "P7_S1_Q2", 5],
  ["개인적인 문제를 잊기 위해 소셜 미디어를 사용했습니까?",               "s1_q3", "P7_S1_Q3", 5],
  ["소셜 미디어 사용을 줄이려고 시도했지만 성공하지 못했습니까?",           "s1_q4", "P7_S1_Q4", 5],
  ["소셜 미디어를 사용하지 못하게 되면 안절부절 못하거나 괴로웠습니까?",     "s1_q5", "P7_S1_Q5", 5],
  ["너무 많이 소셜 미디어를 사용해서 일이나 학업에 부정적인 영향이 있었습니까?","s1_q6","P7_S1_Q6", 5],
];

const SEC2 = [
  ["이상적인 사회에서 어떤 집단은 상위에 있고 다른 집단은 하위에 위치하는 것이 필요하다.", "s2_q1","P7_S2_Q1",5],
  ["어떤 집단은 다른 집단에 비해 열등하다.",                                           "s2_q2","P7_S2_Q2",5],
  ["*어떤 집단도 사회에서 지배적이고 위치를 차지해서는 안 된다.",                       "s2_q3","P7_S2_Q3",5],
  ["*사회의 하위 그룹도 상위 그룹만큼 자격이 있다.",                                     "s2_q4","P7_S2_Q4",5],
  ["집단 간 평등이 우리 사회의 주된 가치가 되어서는 안 된다.",                           "s2_q5","P7_S2_Q5",5],
  ["집단들을 평등하게 만들려고 노력하는 것은 부당하다.",                                 "s2_q6","P7_S2_Q6",5],
  ["*우리는 다양한 집단의 조건을 평등하게 만들기 위해 할 수 있는 것을 해야 한다.",       "s2_q7","P7_S2_Q7",5],
  ["*모든 집단은 성공할 수 있는 동등한 기회를 부여 받아야 한다.",                         "s2_q8","P7_S2_Q8",5],
];

const SEC3 = [
  ["*정서적이고 따뜻하다.",                     "s3_q1","P7_S3_Q1",7],
  ["*따뜻함이 느껴진다.",                       "s3_q2","P7_S3_Q2",7],
  ["*열린 마음/분명한 사고.",                   "s3_q3","P7_S3_Q3",7],
  ["깊이가 없다.",                               "s3_q4","P7_S3_Q4",7],
  ["기계적이고 차갑다.",                         "s3_q5","P7_S3_Q5",7],
  ["물체처럼 느껴진다.",                         "s3_q6","P7_S3_Q6",7],
  ["*세련되고 교양 있다.",                       "s3_q7","P7_S3_Q7",7],
  ["*어른스럽게 느껴진다.",                     "s3_q8","P7_S3_Q8",7],
  ["*자제력이 있다.",                           "s3_q9","P7_S3_Q9",7],
  ["*지적이고 논리적이다.",                     "s3_q10","P7_S3_Q10",7],
  ["인간보다 못한 동물처럼 느껴진다.",           "s3_q11","P7_S3_Q11",7],
  ["세련되지 못하다.",                           "s3_q12","P7_S3_Q12",7],
];

(function(){
  const qs = new URLSearchParams(location.search);
  const pid = qs.get('pid') || localStorage.getItem('exp_pid') || '';
  const nextBtn = document.getElementById('nextBtn');
  let sending = false;

  // 문항 렌더링
  function renderSection(containerId, items){
    const wrap = document.getElementById(containerId);
    items.forEach(([text, name, qkey, scale])=>{
      const q = document.createElement('div');
      q.className = 'q';
      q.innerHTML = `
        <div class="qname">${text}</div>
        <div class="scale" data-name="${name}" data-qkey="${qkey}" data-scale="${scale}"></div>
      `;
      wrap.appendChild(q);
    });
  }
  renderSection('sec1', SEC1);
  renderSection('sec2', SEC2);
  renderSection('sec3', SEC3);

  // 칩(라디오) 생성
  document.querySelectorAll('.scale').forEach(scale=>{
    const name  = scale.dataset.name;
    const max   = parseInt(scale.dataset.scale, 10) || 5;
    for(let v=1; v<=max; v++){
      const lab = document.createElement('label');
      lab.className = 'chip';
      lab.innerHTML = `<input type="radio" name="${name}" value="${v}"><strong>${v}</strong>`;
      scale.appendChild(lab);
    }
  });

  // 칩 선택 스타일(.selected) 토글
  function refreshGroup(name){
    document.querySelectorAll(`label.chip input[name="${name}"]`).forEach(r=>{
      const lab = r.closest('label.chip');
      if (!lab) return;
      lab.classList.toggle('selected', r.checked);
    });
  }
  function wireChipSelection(){
    document.querySelectorAll('label.chip > input[type="radio"]').forEach(r=>{
      refreshGroup(r.name); // 초기 반영
      r.addEventListener('change', ()=>refreshGroup(r.name));
    });
  }
  wireChipSelection();

  // 필수 응답 name 자동 수집
  const REQUIRED = [...document.querySelectorAll('.scale')].map(el=>el.dataset.name);

  function answeredAll(){
    return REQUIRED.every(n => document.querySelector(`input[name="${n}"]:checked`));
  }
  function refreshBtn(){ nextBtn.disabled = !answeredAll() || sending; }

  // 변경 감지
  document.addEventListener('change', (e)=>{
    if (e.target && e.target.matches('input[type="radio"]')) refreshBtn();
  });
  refreshBtn(); // 초기 1회

  function collectAnswers(){
    const out = [];
    document.querySelectorAll('.scale').forEach(scale=>{
      const name = scale.dataset.name;
      const key  = scale.dataset.qkey;
      const el   = document.querySelector(`input[name="${name}"]:checked`);
      if (el) out.push({ key, value: el.value });
    });
    return out;
  }

  async function sessionUpsert(answers){
    const payload = { type:'SESSION_UPSERT', pid, page: PAGE, answers };
    const res = await fetch(API, {
      method: 'POST',
      headers: { 'Content-Type':'text/plain' }, // 심플 요청(preflight 방지)
      body: JSON.stringify(payload)
    });
    if (!res.ok) console.warn('SESSION_UPSERT failed:', res.status);
  }

  nextBtn.addEventListener('click', async ()=>{
    if (!answeredAll() || sending) return;
    sending = true; refreshBtn();

    const answers = collectAnswers(); // [{key:'P7_S1_Q1', value:'3'}, ...]
    try { await sessionUpsert(answers); } catch(e) { console.warn(e); }

    const next = `${NEXT_PAGE_URL}?pid=${encodeURIComponent(pid)}`;
    location.href = next;
  });
})();
</script>
</body>
</html>
