<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>실험 v2 · Page 3 (설문+이름+서명)</title>
<style>
  body{margin:0;background:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Arial,sans-serif;color:#111827;line-height:1.6}
  header{position:sticky;top:0;background:#fff;border-bottom:1px solid #e5e7eb;padding:12px;text-align:center;font-weight:600}
  main{max-width:900px;margin:0 auto;padding:20px;}
  h1{font-size:20px;margin-top:0}
  fieldset{border:1px solid #e5e7eb;border-radius:12px;padding:16px;margin:16px 0}
  legend{font-weight:700}
  .row{display:flex;gap:16px;align-items:center}
  .btn-area{margin:24px 0;text-align:center}
  .btn{border:none;border-radius:10px;padding:12px 20px;font-size:16px;background:#2563eb;color:#fff;font-weight:600;cursor:pointer}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .hint{font-size:12px;color:#6b7280}
  .error{font-size:12px;color:#b91c1c}
</style>
</head>
<body>
<header>Page 3</header>
<main>
  <h1>설문 4문항 + 이름 + 서명</h1>

  <!-- Q1~Q4 라디오 -->
  <fieldset>
    <legend>문항 1</legend>
    <label><input type="radio" name="q1" value="A" data-qkey="P3_Q1"> 선택 A</label><br/>
    <label><input type="radio" name="q1" value="B" data-qkey="P3_Q1"> 선택 B</label>
  </fieldset>

  <fieldset>
    <legend>문항 2</legend>
    <label><input type="radio" name="q2" value="A" data-qkey="P3_Q2"> 선택 A</label><br/>
    <label><input type="radio" name="q2" value="B" data-qkey="P3_Q2"> 선택 B</label>
  </fieldset>

  <fieldset>
    <legend>문항 3</legend>
    <label><input type="radio" name="q3" value="A" data-qkey="P3_Q3"> 선택 A</label><br/>
    <label><input type="radio" name="q3" value="B" data-qkey="P3_Q3"> 선택 B</label>
  </fieldset>

  <fieldset>
    <legend>문항 4</legend>
    <label><input type="radio" name="q4" value="A" data-qkey="P3_Q4"> 선택 A</label><br/>
    <label><input type="radio" name="q4" value="B" data-qkey="P3_Q4"> 선택 B</label>
  </fieldset>

  <!-- 이름 -->
  <fieldset>
    <legend>이름</legend>
    <div class="row">
      <input id="nameInput" type="text" placeholder="예: 김가나" style="flex:1;padding:10px;border:1px solid #e5e7eb;border-radius:8px" />
    </div>
    <div class="hint">실명 입력 (보상 지급 확인용)</div>
  </fieldset>

  <!-- 서명 업로드 -->
  <fieldset>
    <legend>서명 업로드 (jpg/png)</legend>
    <input id="signFile" type="file" accept="image/png, image/jpeg" />
    <div class="hint">흰 종이에 서명 후 사진 촬영 또는 캡처 이미지 업로드. 파일 크기는 가급적 1MB 이하 권장.</div>
    <div id="signNote" class="hint"></div>
    <div id="signErr" class="error"></div>
  </fieldset>

  <div class="btn-area">
    <button id="nextBtn" class="btn" disabled>다음</button>
  </div>
</main>

<script>
/***** ▼ 설정 ▼ *****/
const API = "PUT_YOUR_APPS_SCRIPT_WEBAPP_URL_HERE"; // 동일한 GAS URL
const PAGE = 3;
const NEXT_PAGE_URL = "page4.html";
/***** ▲ 설정 끝 ▲ *****/

(function(){
  const qs = new URLSearchParams(location.search);
  const pid = qs.get('pid') || localStorage.getItem('exp_pid') || '';
  const nextBtn = document.getElementById('nextBtn');
  const nameInput = document.getElementById('nameInput');
  const signFile = document.getElementById('signFile');
  const signErr = document.getElementById('signErr');
  const signNote = document.getElementById('signNote');

  let signDataUrl = '';   // 리사이즈 후 base64
  let signMime = '';      // image/png or image/jpeg

  // ----- 유틸: 버튼 활성화 요건 점검 -----
  function allAnswered(){
    // Q1~Q4 체크
    const groups = ['q1','q2','q3','q4'];
    for (const g of groups) {
      if (!document.querySelector(`input[name="${g}"]:checked`)) return false;
    }
    // 이름
    if (!(nameInput.value.trim().length > 0)) return false;
    // 서명
    if (!signDataUrl) return false;
    return true;
  }
  function refreshButton(){
    nextBtn.disabled = !allAnswered();
  }

  // 모든 입력에 이벤트 연결 (라디오/이름/파일) → “다음” 즉시 반응
  document.querySelectorAll('input[type="radio"][name="q1"],input[type="radio"][name="q2"],input[type="radio"][name="q3"],input[type="radio"][name="q4"]').forEach(el=>{
    el.addEventListener('change', refreshButton);
  });
  nameInput.addEventListener('input', refreshButton);
  signFile.addEventListener('change', handleSignFile);

  // ----- 서명 파일 처리: 타입 확인 → 리사이즈 → dataURL 보관 -----
  async function handleSignFile(){
    signErr.textContent = '';
    signNote.textContent = '';
    signDataUrl = '';
    signMime = '';

    const f = signFile.files && signFile.files[0];
    if (!f) { refreshButton(); return; }

    if (!/^image\/(png|jpeg)$/.test(f.type)) {
      signErr.textContent = 'PNG 또는 JPG 파일만 가능합니다.';
      signFile.value = '';
      refreshButton();
      return;
    }

    try {
      const dataUrl = await fileToDataURL(f);
      const { dataUrl: resized, mime, info } = await resizeImageDataURL(dataUrl, 700); // maxWidth 700px
      signDataUrl = resized;
      signMime = mime;
      signNote.textContent = `서명 이미지 준비됨 · ${info.width}×${info.height}px`;
    } catch (e) {
      console.warn(e);
      signErr.textContent = '이미지 처리 중 오류가 발생했습니다.';
      signFile.value = '';
      signDataUrl = '';
      signMime = '';
    }
    refreshButton();
  }

  function fileToDataURL(file){
    return new Promise((resolve, reject)=>{
      const fr = new FileReader();
      fr.onload = ()=> resolve(String(fr.result));
      fr.onerror = reject;
      fr.readAsDataURL(file);
    });
  }

  // dataURL → canvas 리사이즈 → jpeg/png dataURL 반환
  function resizeImageDataURL(dataUrl, maxWidth=700){
    return new Promise((resolve, reject)=>{
      const img = new Image();
      img.onload = ()=>{
        let { width, height } = img;
        if (width > maxWidth) {
          const ratio = maxWidth / width;
          width = Math.round(width * ratio);
          height = Math.round(height * ratio);
        }
        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);

        // 원본이 png면 png, jpg면 jpeg으로 유지(용량 줄이려면 jpeg 권장)
        const mime = /image\/png/.test(dataUrl) ? 'image/png' : 'image/jpeg';
        const out = canvas.toDataURL(mime, 0.8); // jpeg일 때 품질 0.8
        resolve({ dataUrl: out, mime, info:{width, height} });
      };
      img.onerror = reject;
      img.src = dataUrl;
    });
  }

  // ----- 제출(최종 1회만 전송) -----
  nextBtn.addEventListener('click', onSubmit, { once:false });

  async function onSubmit(){
    if (!allAnswered()) return; // 안전장치

    // 응답 수집
    const q = (name)=> (document.querySelector(`input[name="${name}"]:checked`)?.value || '');
    const answers = [
      { key: 'P3_Q1', value: q('q1') },
      { key: 'P3_Q2', value: q('q2') },
      { key: 'P3_Q3', value: q('q3') },
      { key: 'P3_Q4', value: q('q4') },
      { key: 'P3_NAME', value: nameInput.value.trim() },
      { key: 'P3_SIGN_MIME', value: signMime },
      // dataURL 앞부분 "data:image/png;base64," 제거해서 셀 길이 절약
      { key: 'P3_SIGN_DATA', value: signDataUrl.replace(/^data:[^,]+,/, '') }
    ];

    nextBtn.disabled = true;
    try {
      const payload = { type:'SESSION_UPSERT', pid, page: PAGE, answers };
      const res = await fetch(API, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify(payload)
      });
      if (!res.ok) console.warn('SESSION_UPSERT failed:', res.status);
    } catch (e) {
      console.warn(e);
    }
    // 다음 페이지
    const next = `${NEXT_PAGE_URL}?pid=${encodeURIComponent(pid)}`;
    location.href = next;
  }

  // 초기 버튼 상태
  refreshButton();
})();
</script>
</body>
</html>
