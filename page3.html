<button id="nextBtn" class="btn primary">다음</button>

<script>
const API = "https://script.google.com/macros/s/AKfycbxhI7GJJI2jebIWhxr_3nkvvYStEtzNjFZpUuIezsnNKd7G1Mf8emvyrW_AJUsZNg2U/exec";
const PAGE = 3;
const NEXT_PAGE_URL = "page4.html";

(function(){
  const qs = new URLSearchParams(location.search);
  const pid = qs.get('pid') || localStorage.getItem('exp_pid') || '';
  const nextBtn = document.getElementById('nextBtn');
  const pname = document.getElementById('pname');

  const qNames = ['q1','q2','q3','q4'];
  function getAnswers(){
    const out = {};
    for(const n of qNames){
      const v = (document.querySelector(`input[name="${n}"]:checked`)||{}).value || null;
      out[n] = v;
    }
    return out;
  }
  function allYes(ans){ 
    return ['q1','q2','q3','q4'].every(k => (ans[k]||'').trim() === '예');
  }

  function syncState(){
    const ans = getAnswers();
    const ok = allYes(ans) && !!pname.value.trim();
    nextBtn.disabled = !ok;
  }

  document.querySelectorAll('input[type="radio"]').forEach(el=>el.addEventListener('change', syncState));
  pname.addEventListener('input', syncState);

  // ✅ 로드 직후 한 번 상태 동기화
  syncState();

  async function sessionUpsert(answers){
    const payload = { type:'SESSION_UPSERT', pid, page: PAGE, answers };
    const res = await fetch(API, {
      method:'POST',
      headers:{ 'Content-Type':'text/plain' },
      body: JSON.stringify(payload)
    });
    if(!res.ok) console.warn('SESSION_UPSERT failed:', res.status);
  }

  nextBtn.addEventListener('click', async ()=>{
    const ans = getAnswers();
    if(!allYes(ans)) return;
    const name = pname.value.trim();

    const answers = [
      { key:'P3_Q1', value: ans.q1 },
      { key:'P3_Q2', value: ans.q2 },
      { key:'P3_Q3', value: ans.q3 },
      { key:'P3_Q4', value: ans.q4 },
      { key:'P3_NAME', value: name }
    ];
    try { await sessionUpsert(answers); } catch(e) { console.warn(e); }

    const next = `${NEXT_PAGE_URL}?pid=${encodeURIComponent(pid)}`;
    location.href = next;
  });
})();
</script>

