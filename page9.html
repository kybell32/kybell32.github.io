<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>실험 v2 · Page 9 (종속 변인 측정)</title>
<style>
  :root{--line:#e5e7eb;--pri:#2563eb;--bg:#f6f7f9}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Arial,sans-serif;color:#111827;line-height:1.6}
  header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);padding:12px;text-align:center;font-weight:700}
  main{max-width:880px;margin:0 auto;padding:18px}
  h1{font-size:20px;margin:6px 0 18px}
  .card{background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.04);padding:16px;margin:14px 0}
  .qtitle{font-weight:700;margin-bottom:8px}
  .help{font-size:12px;color:#6b7280;margin-bottom:8px}
  .scale{display:flex;flex-wrap:wrap;gap:8px}
  .chip{
    display:flex;align-items:center;gap:6px;
    border:1px solid var(--line);border-radius:999px;padding:8px 10px;cursor:pointer;
    user-select:none;background:#fff
  }
  .chip input{appearance:none;width:16px;height:16px;border:2px solid #9ca3af;border-radius:999px;display:inline-block}
  .chip input:checked{border-color:#2563eb;background:#2563eb}
  .chip strong{font-variant-numeric:tabular-nums}
  .btn-area{text-align:center;margin-top:24px}
  .btn{border:none;border-radius:10px;padding:12px 20px;font-size:16px;background:var(--pri);color:#fff;font-weight:600;cursor:pointer}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  @media (max-width:640px){ .scale{gap:6px} .chip{padding:8px} }
</style>
</head>
<body>
<header>종속 변인 측정</header>
<main>
  <h1>아래 문항에 응답해 주세요. 모든 문항에 응답해야 다음으로 이동할 수 있습니다.</h1>

  <!-- 섹션 1: 설득/수용 관련 (3문항) -->
  <section class="card">
    <div class="qtitle">앞서 본 온라인 게시물의 의견에 대해 어떻게 생각하십니까?</div>
    <div class="help">각 문항에 대해 1(전혀 그렇지 않다) ~ 7(매우 그렇다) 중 하나를 선택해 주세요.</div>

    <div class="card">
      <div class="qtitle">1) 의견에 결코 동의할 수 없다.</div>
      <div class="scale" data-name="s1_q1" data-qkey="P9_S1_Q1"></div>
    </div>

    <div class="card">
      <div class="qtitle">2) 의견에 허점이 있다고 생각한다.</div>
      <div class="scale" data-name="s1_q2" data-qkey="P9_S1_Q2"></div>
    </div>

    <div class="card">
      <div class="qtitle">3) <em>의견을 쉽게 받아들였다.</em></div>
      <div class="scale" data-name="s1_q3" data-qkey="P9_S1_Q3"></div>
    </div>
  </section>

  <!-- 섹션 2: 공격/차별/혐오 인식 (3문항) -->
  <section class="card">
    <div class="qtitle">앞서 본 게시물이 특정 집단에 대해 어떻게 발언한다고 보십니까?</div>
    <div class="help">1(전혀 그렇지 않다) ~ 7(매우 그렇다)</div>

    <div class="card">
      <div class="qtitle">4) 공격적인 발언을 하고 있다.</div>
      <div class="scale" data-name="s2_q1" data-qkey="P9_S2_Q1"></div>
    </div>

    <div class="card">
      <div class="qtitle">5) 차별적인 발언을 하고 있다.</div>
      <div class="scale" data-name="s2_q2" data-qkey="P9_S2_Q2"></div>
    </div>

    <div class="card">
      <div class="qtitle">6) 혐오적인 발언을 하고 있다.</div>
      <div class="scale" data-name="s2_q3" data-qkey="P9_S2_Q3"></div>
    </div>
  </section>

  <div class="btn-area">
    <button id="nextBtn" class="btn" disabled>다음</button>
  </div>
</main>

<script>
/***** ▼ 설정 ▼ *****/
const API = "https://script.google.com/macros/s/AKfycbxhI7GJJI2jebIWhxr_3nkvvYStEtzNjFZpUuIezsnNKd7G1Mf8emvyrW_AJUsZNg2U/exec";
const PAGE = 9;
const NEXT_PAGE_URL = "page10.html";
/***** ▲ 설정 끝 ▲ *****/

(function(){
  const qs = new URLSearchParams(location.search);
  const pid = qs.get('pid') || localStorage.getItem('exp_pid') || '';
  const nextBtn = document.getElementById('nextBtn');
  let sending = false;

  // 1) 1~7 칩 UI 자동 생성
  document.querySelectorAll('.scale').forEach(scale=>{
    const name = scale.dataset.name;
    for(let v=1; v<=7; v++){
      const lab = document.createElement('label');
      lab.className = 'chip';
      lab.innerHTML = `<input type="radio" name="${name}" value="${v}"><strong>${v}</strong>`;
      scale.appendChild(lab);
    }
  });

  // 2) 필수 이름 목록
  const REQUIRED = ['s1_q1','s1_q2','s1_q3','s2_q1','s2_q2','s2_q3'];

  function answeredAll(){
    return REQUIRED.every(n => document.querySelector(`input[name="${n}"]:checked`));
  }
  function refreshBtn(){ nextBtn.disabled = !answeredAll() || sending; }

  // 이벤트 위임으로 변경 감지
  document.addEventListener('change', (e)=>{
    if (e.target && e.target.matches('input[type="radio"]')) refreshBtn();
  });
  // 초기 1회 체크
  refreshBtn();

  function collectAnswers(){
    const out = [];
    document.querySelectorAll('.scale').forEach(scale=>{
      const name = scale.dataset.name;
      const key  = scale.dataset.qkey;
      const val  = (document.querySelector(`input[name="${name}"]:checked`) || {}).value;
      if (val) out.push({ key, value: val });
    });
    return out;
  }

  async function sessionUpsert(answers){
    const payload = { type:'SESSION_UPSERT', pid, page: PAGE, answers };
    const res = await fetch(API, {
      method: 'POST',
      headers: { 'Content-Type':'text/plain' }, // 심플 요청 → preflight 없음
      body: JSON.stringify(payload)
    });
    if (!res.ok) console.warn('SESSION_UPSERT failed:', res.status);
  }

  nextBtn.addEventListener('click', async ()=>{
    if (!answeredAll() || sending) return;
    sending = true; refreshBtn();

    const answers = collectAnswers(); // [{key:'P9_S1_Q1', value:'...'}, ...]
    try { await sessionUpsert(answers); } catch(e) { console.warn(e); }

    const next = `${NEXT_PAGE_URL}?pid=${encodeURIComponent(pid)}`;
    location.href = next;
  });
})();
</script>
</body>
</html>
